!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=17)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAttr=t.createDom=t.getDomList=t.getDom=void 0,t.getDom=function(e){return document.querySelector(e)},t.getDomList=function(e){return document.querySelectorAll(e)},t.createDom=function(e="div",t,n){const o=document.createElement(e);return t&&(o.className=t),n&&(o.id=n),o},t.getAttr=function(e,t){return e.getAttribute(t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lighter=t.rgbToHEX=t.hexToRGB=void 0;function o(e){if(!/^#[A-Fa-f0-9]{6}$/.test(e))return null;let t;return t="0x"+e.substring(1),{r:t>>16&255,g:t>>8&255,b:255&t}}function i(e){return`#${e.r.toString(16)}${e.g.toString(16)}${e.b.toString(16)}`}t.default={blue:"#b3e5fc",font:"#333333",line:"#c1c1c1",green:"#c5e1a5",red:"#ffcdd2",lingthBlue:"#e3f2fd",white:"#ffffff"},t.hexToRGB=o,t.rgbToHEX=i,t.lighter=function(e,t=5){const n=o(e);return i({r:Math.floor((n.r*t+255*(10-t))/10),g:Math.floor((n.g*t+255*(10-t))/10),b:Math.floor((n.b*t+255*(10-t))/10)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Event=void 0;t.Event=class{constructor({rect:e}){this.mobileEvent={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"};const t=window&&window.navigator.userAgent||"";this.isMobile=!!t.toLowerCase().match(/iphone|mobile|andriod/),this.baseRect=e,this.isMobile&&document.body.addEventListener("touchmove",e=>{e.preventDefault()},{passive:!1})}add(e,t,n){e&&(t=this.isMobile&&this.mobileEvent[t]||t,e.addEventListener(t,e=>{if(this.isMobile){let o="touchend"===t?e.changedTouches[0]:e.touches[0];o.offsetX=o.clientX-this.baseRect.left,o.offsetY=o.clientY-this.baseRect.top,n(o)}else n(e)}))}}},function(e,t,n){"use strict";var o=n(7),i=n.n(o),s=n(8),r=n.n(s)()(i.a);r.push([e.i,".editor-container {\n    position: relative;\n}\n/* editor */\n.editor-page {\n    position: relative;\n    flex: 1;\n    z-index: 1;\n    background-color: #F3F4F8;\n}\n.editor-page > canvas {\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    left: 0;\n    top: 0;\n    cursor: default;\n}\n\n/* contextmenu */\n.editor-contextmenu {\n    display: none;\n    position: fixed;\n    width: 100px;\n    padding: 5px 0;\n    background-color: #fff;\n    z-index: 9;\n    flex-direction: column;\n    border-radius: 2px;\n    overflow: hidden;\n}\n.editor-contextmenu.show {\n    display: flex;\n}\n.editor-contextmenu-item {\n    padding: 5px 10px;\n    cursor: default;\n    transition: color .2s ease;\n}\n.editor-contextmenu-item:hover {\n    color: #03a9f4;\n}\n","",{version:3,sources:["webpack://style/editor.css"],names:[],mappings:"AAAA;IACI,kBAAkB;AACtB;AACA,WAAW;AACX;IACI,kBAAkB;IAClB,OAAO;IACP,UAAU;IACV,yBAAyB;AAC7B;AACA;IACI,kBAAkB;IAClB,WAAW;IACX,YAAY;IACZ,OAAO;IACP,MAAM;IACN,eAAe;AACnB;;AAEA,gBAAgB;AAChB;IACI,aAAa;IACb,eAAe;IACf,YAAY;IACZ,cAAc;IACd,sBAAsB;IACtB,UAAU;IACV,sBAAsB;IACtB,kBAAkB;IAClB,gBAAgB;AACpB;AACA;IACI,aAAa;AACjB;AACA;IACI,iBAAiB;IACjB,eAAe;IACf,0BAA0B;AAC9B;AACA;IACI,cAAc;AAClB",sourcesContent:[".editor-container {\n    position: relative;\n}\n/* editor */\n.editor-page {\n    position: relative;\n    flex: 1;\n    z-index: 1;\n    background-color: #F3F4F8;\n}\n.editor-page > canvas {\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    left: 0;\n    top: 0;\n    cursor: default;\n}\n\n/* contextmenu */\n.editor-contextmenu {\n    display: none;\n    position: fixed;\n    width: 100px;\n    padding: 5px 0;\n    background-color: #fff;\n    z-index: 9;\n    flex-direction: column;\n    border-radius: 2px;\n    overflow: hidden;\n}\n.editor-contextmenu.show {\n    display: flex;\n}\n.editor-contextmenu-item {\n    padding: 5px 10px;\n    cursor: default;\n    transition: color .2s ease;\n}\n.editor-contextmenu-item:hover {\n    color: #03a9f4;\n}\n"],sourceRoot:""}]),t.a=r},function(e,t,n){"use strict";function o(e,t,n,o){const{x:i,y:s,w:r,h:a}=e;return{x:i-r/2+(n+1)/(o+1)*r,y:"input"===t?s-a/2:s+a/2}}function i({x:e,y:t},{x:n,y:o},i=4){return Math.abs(e-n)<=i&&Math.abs(t-o)<=i}Object.defineProperty(t,"__esModule",{value:!0}),t.logger=t.compareEdge=t.checkInCircle=t.checkInNodeAnchor=t.getAnchorPos=t.randomID=void 0,t.randomID=function(){return Date.now().toString(16)},t.getAnchorPos=o,t.checkInNodeAnchor=function({x:e,y:t},n){const{input:s,output:r}=n.anchors;if(s)for(let r=0;r<s;r++){if(i({x:e,y:t},o(n,"input",r,s)))return[n,"input",r]}if(r)for(let s=0;s<r;s++){if(i({x:e,y:t},o(n,"output",s,r)))return[n,"output",s]}return null},t.checkInCircle=i,t.compareEdge=function(e,t){for(let n in e)if(e[n]!==t[n])return!1;return!0},t.logger=function(e){0}},function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(11),t),i(n(16),t)},function(e,t,n){"use strict";var o,i=function(){return void 0===o&&(o=Boolean(window&&document&&document.all&&!window.atob)),o},s=function(){var e={};return function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}e[t]=n}return e[t]}}(),r=[];function a(e){for(var t=-1,n=0;n<r.length;n++)if(r[n].identifier===e){t=n;break}return t}function c(e,t){for(var n={},o=[],i=0;i<e.length;i++){var s=e[i],c=t.base?s[0]+t.base:s[0],d=n[c]||0,l="".concat(c," ").concat(d);n[c]=d+1;var h=a(l),u={css:s[1],media:s[2],sourceMap:s[3]};-1!==h?(r[h].references++,r[h].updater(u)):r.push({identifier:l,updater:g(u,t),references:1}),o.push(l)}return o}function d(e){var t=document.createElement("style"),o=e.attributes||{};if(void 0===o.nonce){var i=n.nc;i&&(o.nonce=i)}if(Object.keys(o).forEach((function(e){t.setAttribute(e,o[e])})),"function"==typeof e.insert)e.insert(t);else{var r=s(e.insert||"head");if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}return t}var l,h=(l=[],function(e,t){return l[e]=t,l.filter(Boolean).join("\n")});function u(e,t,n,o){var i=n?"":o.media?"@media ".concat(o.media," {").concat(o.css,"}"):o.css;if(e.styleSheet)e.styleSheet.cssText=h(t,i);else{var s=document.createTextNode(i),r=e.childNodes;r[t]&&e.removeChild(r[t]),r.length?e.insertBefore(s,r[t]):e.appendChild(s)}}function f(e,t,n){var o=n.css,i=n.media,s=n.sourceMap;if(i?e.setAttribute("media",i):e.removeAttribute("media"),s&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),e.styleSheet)e.styleSheet.cssText=o;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(o))}}var v=null,p=0;function g(e,t){var n,o,i;if(t.singleton){var s=p++;n=v||(v=d(t)),o=u.bind(null,n,s,!1),i=u.bind(null,n,s,!0)}else n=d(t),o=f.bind(null,n,t),i=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)};return o(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;o(e=t)}else i()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=i());var n=c(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var o=0;o<n.length;o++){var i=a(n[o]);r[i].references--}for(var s=c(e,t),d=0;d<n.length;d++){var l=a(n[d]);0===r[l].references&&(r[l].updater(),r.splice(l,1))}n=s}}}},function(e,t,n){"use strict";function o(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],o=!0,i=!1,s=void 0;try{for(var r,a=e[Symbol.iterator]();!(o=(r=a.next()).done)&&(n.push(r.value),!t||n.length!==t);o=!0);}catch(e){i=!0,s=e}finally{try{o||null==a.return||a.return()}finally{if(i)throw s}}return n}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}e.exports=function(e){var t=o(e,4),n=t[1],i=t[3];if("function"==typeof btoa){var s=btoa(unescape(encodeURIComponent(JSON.stringify(i)))),r="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),a="/*# ".concat(r," */"),c=i.sources.map((function(e){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(e," */")}));return[n].concat(c).concat([a]).join("\n")}return[n].join("\n")}},function(e,t,n){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=e(t);return t[2]?"@media ".concat(t[2]," {").concat(n,"}"):n})).join("")},t.i=function(e,n,o){"string"==typeof e&&(e=[[null,e,""]]);var i={};if(o)for(var s=0;s<this.length;s++){var r=this[s][0];null!=r&&(i[r]=!0)}for(var a=0;a<e.length;a++){var c=[].concat(e[a]);o&&i[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),t.push(c))}},t}},function(e,t,n){"use strict";function o(e){if(void 0!==e.count)return e.count;e.count=0;const{children:t}=e;if(t)for(let n=0,i=t.length;n<i;n++)e.count+=o(t[n]);else e.count++;return e.count}Object.defineProperty(t,"__esModule",{value:!0}),t.figureNodeLevel=t.getLeavesCount=void 0,t.getLeavesCount=o,t.figureNodeLevel=function e(t,n=0){if(t.level=n,t.count=o(t),!t.children)return!1;for(let o=0,i=t.children.length;o<i;o++)e(t.children[o],n+1)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor({selector:e}){this.events={},this.oToolbar=document.querySelector(e),this._bind()}registerCommands(e){this.events=Object.assign(Object.assign({},this.events),e)}_bind(){this.oToolbar.addEventListener("click",e=>{const t=e.target.getAttribute("data-command");if(!t)return;const n=this.events[t];n&&n(e)})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Editor=void 0,n(12);const o=n(0),i=n(4),s=n(13),r=n(2),a=n(14),c=n(15);t.Editor=class{constructor({container:e,itempanel:t,page:n}){this.anchorStartPos={x:0,y:0},this.callback={selectedNodeChange:null,nodeAdded:null,nodeDeleted:null,edgeAdded:null,edgeDeleted:null},this.isMouseDown=!1,this.eventList=[["oItemPanel","mousedown","_beginAddNode"],["oItemPanel","mouseup","_mouseUp"],["oPage","mousedown","_mouseDownOnPage"],["oPage","mousemove","_mouseMove"],["oPage","mouseleave","_mouseLeavePage"],["oPage","mouseup","_mouseUpPage"],["oContainer","contextmenu","_preventDefaultMenu"]],this.mouseEventStartPos={x:0,y:0},this.commands={"del:node":"_delNodeCommand","del:edge":"_delEdgeCommand",clear:"_clear"},console.info("%csimple-dag-editor: created","color: #c5e1a5;font-weight: bold;"),this.oContainer=o.getDom(e),this.oItemPanel=o.getDom(t),this.oPage=o.getDom(n),this.shapes={},this.nodes=[],this.edges=[],this._init()}_init(){this._initCanvas(),this._bindEvents(),this._initCommand()}resize(){}_initPageConfig(){if(!this.oPage||!this.oContainer)throw Error("cannot find Editor editor container");this.oPage.classList.add("editor-page"),this.oContainer.classList.add("editor-container");let e=this.oPage.getBoundingClientRect();const t=window.devicePixelRatio||1;e=e.toJSON(),this.pageConfig=Object.assign(Object.assign({},e),{ratio:t})}_initCanvas(){this._initPageConfig();const{width:e,height:t,ratio:n}=this.pageConfig,i=o.createDom("canvas","editor-canvas");i.width=e*n,i.height=t*n;const r=i.cloneNode();r.style.pointerEvents="none",r.style.backgroundColor="transparent",this.mainCvs=new s.Canvas(i,{ratio:n,hasStore:!0}),this.dynamicCvs=new s.Canvas(r,{ratio:n}),this.oPage.appendChild(i),this.oPage.appendChild(r)}registerShape(e,t){this.shapes[e]=t}get selectedNode(){return this.__selectedNode}set selectedNode(e){e!==this.__selectedNode?(this.__selectedNode=e,this._renderTask("selected node change"),this.callback.selectedNodeChange&&this.callback.selectedNodeChange(e)):i.logger("no change")}get hoverNode(){return this.__hoverNode}set hoverNode(e){e!==this.__hoverNode&&(this.__hoverNode=e,this._renderTask("hover node change"))}_addNode(e){this.nodes.push(Object.assign(Object.assign({},e),{id:i.randomID()}));let t=this.nodes[this.nodes.length-1];this.callback.nodeAdded&&this.callback.nodeAdded(t),this.selectedNode=t}_updateNode(e){let t=this.nodes.findIndex(t=>t.id===e.id);if(t<0)return;let n=this.nodes.splice(t,1)[0];n=Object.assign({},e),this.nodes.push(n),this.selectedNode=n}_delNode(e){let t=this.nodes.findIndex(t=>t.id===e);if(t>-1){this.nodes.splice(t,1);let n=this._getRelatedEdge(e);n.length&&n.forEach(e=>{this._delEdge(e.id)}),this.selectedNode=null,this.callback.nodeDeleted&&this.callback.nodeDeleted(e)}}get selectedEdge(){return this.__selectedEdge}set selectedEdge(e){e!==this.__selectedEdge&&(this.__selectedEdge=e,this._renderTask("selected edge change"))}_addEdge([e,t],[n,o]){let s={source:e.id,sourceAnchorIndex:t,target:n.id,targetAnchorIndex:o};this.edges.find(e=>i.compareEdge(s,e))||(this.edges.push(Object.assign(Object.assign({},s),{id:i.randomID()})),this.callback.edgeAdded&&this.callback.edgeAdded(s))}_delEdge(e){let t=this.edges.findIndex(t=>t.id===e);if(t>-1){let[e]=this.edges.splice(t,1);this.callback.edgeDeleted&&this.callback.edgeDeleted(e)}}_clear(){this.nodes=[],this.edges=[],this._renderTask("clear")}_renderTask(e){this.renderTask&&cancelAnimationFrame(this.renderTask),this.renderTask=window.requestAnimationFrame(()=>{this._render(e)})}_render(e){e&&i.logger(`===render by: ${e}===`),this.mainCvs.clear(),this.mainCvs.preFill(),this.nodes.forEach(e=>{let t=this.selectedNode===e?"selected":this.hoverNode===e?"hover":null;this.mainCvs.paintNode(e,{status:t})}),this.edges.forEach(({source:e,sourceAnchorIndex:t,target:n,targetAnchorIndex:o,id:s})=>{const r=this.nodes.find(t=>t.id===e),a=this.nodes.find(e=>e.id===n);this.mainCvs.paintEdge(i.getAnchorPos(r,"output",t,r.anchors.output),i.getAnchorPos(a,"input",o,a.anchors.input),{id:s,selected:this.selectedEdge&&this.selectedEdge.id===s})})}on(e,t){this.callback.hasOwnProperty(e)&&(this.callback[e]=t)}update(e){}repaint(){this._renderTask("repaint")}getData(){return{nodes:this.nodes,edges:this.edges}}saveFile(e="simple-dag-editor-export-picture",t="jpeg"){return new Promise(n=>{this.getFileBlob(t).then(o=>{const i=URL.createObjectURL(o),s=document.createElement("a");s.download=`${e}.${t}`,s.href=i,s.click(),n(i)})})}getFileBlob(e){const{canvas:t}=this.mainCvs,n="image/"+e;return new Promise(e=>{t.toBlob(t=>{e(t)},n)})}_bindEvents(){const e=new r.Event({rect:this.pageConfig});for(let t of this.eventList)e.add(this[t[0]],t[1],this[t[2]].bind(this))}_beginAddNode(e){const t=e.target,n=o.getAttr(t,"data-shape");n&&(this.isMouseDown=!0,this.mouseDownType="add-node",this.selectedShape=this.shapes[n])}_mouseDownOnPage(e){this.isMouseDown=!0;const{offsetX:t,offsetY:n}=e;if(this.mouseEventStartPos={x:t,y:n},this.hoverNode)if(this.selectedNode=this.hoverNode,this.selectedEdge=null,this.hoverAnchor){const[e,t,n]=this.hoverAnchor;this.mouseDownType="output"===t?"add-edge":null,this.anchorStartPos=i.getAnchorPos(e,t,n,e.anchors[t])}else this.mouseDownType="move-node";else this.selectedNode=null,this.selectedEdge=this._getSelectedEdge({x:t,y:n}),this.mouseDownType="drag-canvas";this._triggerMenu(2===e.button,e)}_mouseMove(e){this.dynamicCvs.clear();const{offsetX:t,offsetY:n}=e,o=t-this.mouseEventStartPos.x,i=n-this.mouseEventStartPos.y,{tx:s,ty:r}=this.dynamicCvs.translateInfo;if(this.isMouseDown)switch(this.mouseDownType){case"add-node":this.dynamicCvs.paintNode(Object.assign(Object.assign({},this.selectedShape),{x:t-s,y:n-r}));break;case"move-node":this.dynamicCvs.paintNode(Object.assign(Object.assign({},this.selectedNode),{x:this.selectedNode.x+o,y:this.selectedNode.y+i}));break;case"add-edge":this.nodes.forEach(e=>{e.id!==this.selectedNode.id&&e.anchors&&this.dynamicCvs.paintActiveAnchors(e)}),this.dynamicCvs.paintEdge(this.anchorStartPos,{x:t,y:n},{needTranslate:!0});break;case"drag-canvas":this.mainCvs.clear(),this.mainCvs.transform(o,i),this.dynamicCvs.transform(o,i),this._render(),this.mainCvs.restore(),this.dynamicCvs.restore()}else{const e=this._getSelectedNode({x:t,y:n});if(this.hoverNode){let o=this.mainCvs.checkInNodeAnchor(this.hoverNode,{x:t,y:n});this.hoverAnchor=o,o||(this.hoverNode=e)}else this.hoverAnchor=null,this.hoverNode=e}}_mouseLeavePage(){this._mouseUp()}_mouseUpPage(e){if(!this.isMouseDown)return;const{offsetX:t,offsetY:n}=e,o=t-this.mouseEventStartPos.x,s=n-this.mouseEventStartPos.y,{tx:r,ty:a}=this.dynamicCvs.translateInfo;switch(this.mouseDownType){case"add-node":this._addNode(Object.assign(Object.assign({},this.selectedShape),{x:t-r,y:n-a}));break;case"move-node":if(Math.abs(o)<5&&Math.abs(s)<5)break;i.logger("move"),this._updateNode(Object.assign(Object.assign({},this.selectedNode),{x:this.selectedNode.x+o,y:this.selectedNode.y+s}));break;case"add-edge":this.nodes.forEach(e=>{if(e.id!==this.selectedNode.id){const o=this.mainCvs.checkInNodeAnchor(e,{x:t,y:n},{active:!0});o&&"input"===o[1]&&this._addEdge([this.hoverAnchor[0],this.hoverAnchor[2]],[e,o[2]])}});break;case"drag-canvas":this.mainCvs.translate(o,s),this.dynamicCvs.translate(o,s)}this._mouseUp()}_mouseUp(){this.isMouseDown=!1,this.mouseDownType=null,this.dynamicCvs.clear()}_initCommand(){const e=new a.Command({app:this}),{commands:t}=this;for(let n in t)e.register(n,this[t[n]]);this.command=e,this.contextmenu=new c.ContextMenu({app:this,command:e,container:this.oContainer})}_triggerMenu(e,t){if(e){let e={type:null};this.selectedNode?e.type="node":this.selectedEdge&&(e.type="edge"),this.contextmenu.attach(t,e)}else this.contextmenu.detach()}_preventDefaultMenu(e){e.preventDefault()}_delNodeCommand(){this._delNode(this.selectedNode.id)}_delEdgeCommand(){this._delEdge(this.selectedEdge.id),this.selectedEdge=null}_getSelectedNode({x:e,y:t}){const{nodes:n}=this;for(let o=n.length;o>0;o--){let i=n[o-1];if(this.mainCvs.checkInNode(i.id,{x:e,y:t}))return i}return null}_getSelectedEdge({x:e,y:t}){const{edges:n}=this;for(let o of n)if(this.mainCvs.checkOnEdge(o.id,{x:e,y:t}))return o;return null}_getRelatedEdge(e){let t=[];return this.edges.forEach(n=>{n.source!==e&&n.target!==e||t.push(n)}),t}}},function(e,t,n){"use strict";n.r(t);var o=n(6),i=n.n(o),s=n(3),r={insert:"head",singleton:!1};i()(s.a,r);t.default=s.a.locals||{}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Canvas=void 0;const o=n(1),i=n(4);t.Canvas=class{constructor(e,{ratio:t=1,fillStyle:n=o.default.white,strokeStyle:i=o.default.line,hasStore:s}){this.canvas=e,this.ratio=t;const r=e.getContext("2d");r.fillStyle=n,r.strokeStyle=i,r.textAlign="center",r.textBaseline="middle",r.font=Math.max(10*t,12)+"px Helvetica Neue,Helvetica,PingFang SC,Microsoft YaHei,sans-serif",this.ctx=r,this.hasStore=s,this.paths={nodes:{},edges:{},anchors:{},activeAnchors:{}},this.translateInfo={x:0,y:0,tx:0,ty:0}}translate(e,t){const{ratio:n,ctx:o}=this;this.translateInfo.tx+=e,this.translateInfo.ty+=t,e*=n,t*=n,o.translate(e,t),this.translateInfo.x+=e,this.translateInfo.y+=t,i.logger(`===translate: (${this.translateInfo.x}, ${this.translateInfo.y})===`)}transform(e,t){const{ctx:n,ratio:o}=this;n.save(),n.transform(1,0,0,1,e*o,t*o)}restore(){this.ctx.restore()}paintNode(e,t){const{ctx:n,ratio:s}=this;let{x:r,y:a,w:c,h:d}=e;r*=s,a*=s,c*=s,d*=s;const l=r-c/2,h=a-d/2;n.save();const u=this._paintRoundRect(l+2*s,h+2*s,c,d,4*s);n.fillStyle="rgba(35,35,35,0.08)",n.fill(u),n.restore();const f=this._paintRoundRect(l,h,c,d,4*s);e.id&&this.hasStore&&(this.paths.nodes[e.id]=f),n.fill(f),n.save();const v=this._paintRoundRect(l,h,4*s,d,4*s,!0);if(n.fillStyle=e.color||o.default.blue,n.fill(v),n.restore(),e.id&&t&&t.status){n.save(),n.strokeStyle=e.color||o.default.blue,n.lineWidth=2,n.stroke(f);const{anchors:t}=e;this.paths.anchors[e.id]=[],this.paths.activeAnchors[e.id]=[],Object.keys(t).forEach(o=>{if(t[o])for(let s=0;s<t[o];s++){let r=i.getAnchorPos(e,o,s,t[o]),[a,c]=this._paintAnchor(r);n.fill(a),n.stroke(a),this.paths.anchors[e.id].push({type:o,index:s,path:a}),this.paths.activeAnchors[e.id].push({type:o,index:s,path:c})}}),n.restore()}n.save(),n.fillStyle=o.default.font,n.fillText(e.name||e.shape,r,a),n.restore()}_paintRoundRect(e,t,n,o,i,s){const r=new Path2D;return r.moveTo(e+i,t),s?r.lineTo(e+i,t+o):(r.arcTo(e+n,t,e+n,t+o,i),r.arcTo(e+n,t+o,e,t+o,i)),r.arcTo(e,t+o,e,t,i),r.arcTo(e,t,e+i,t,i),r.closePath(),r}checkInNode(e,t){const n=this.ratio,o=this.paths.nodes[e];let{x:i,y:s}=t;return i*=n,s*=n,o&&this.ctx.isPointInPath(o,i,s)}_paintAnchor({x:e,y:t}){const{ratio:n}=this;e*=n,t*=n;const o=new Path2D;o.arc(e,t,4*n,0,2*Math.PI,!1);const i=new Path2D;return i.arc(e,t,12*n,0,2*Math.PI,!1),[o,i]}checkInNodeAnchor(e,t,n){const o=this.ratio;let{x:i,y:s}=t;i*=o,s*=o;const r=n&&n.active?this.paths.activeAnchors[e.id]:this.paths.anchors[e.id];for(let t=0,n=r.length;t<n;t++){const n=r[t];if(this.ctx.isPointInPath(n.path,i,s))return[e,n.type,n.index]}return null}paintActiveAnchors(e){const{ctx:t}=this,{input:n}=e.anchors;if(n)for(let s=0;s<n;s++){let r=i.getAnchorPos(e,"input",s,n),[a,c]=this._paintAnchor(r);t.save(),t.fillStyle=o.lighter(e.color||o.default.blue),t.fill(c),t.restore(),t.fill(a),t.stroke(a)}}paintEdge({x:e,y:t},{x:n,y:o},i){const{ctx:s,ratio:r}=this;e*=r,t*=r,n*=r,o*=r,i.needTranslate&&(n-=this.translateInfo.x,o-=this.translateInfo.y);const a=new Path2D;s.beginPath(),a.moveTo(e,t);let c=Math.abs(o-t);const d=[e,t+c/4],l=[n,o-c/2];a.bezierCurveTo(d[0],d[1],l[0],l[1],n,o),i&&i.selected?(s.save(),s.lineWidth=2*r,s.stroke(a),s.restore()):s.stroke(a),i&&i.id&&this.hasStore&&(this.paths.edges[i.id]=a),s.closePath(),this._paintArrow({x:n,y:o})}checkOnEdge(e,t){const{ratio:n,ctx:o}=this,i=this.paths.edges[e];let{x:s,y:r}=t;s*=n,r*=n,o.save(),o.lineWidth=6*n;let a=i&&o.isPointInStroke(i,s,r);return o.restore(),a}_paintArrow({x:e,y:t}){const{ctx:n,ratio:i}=this;n.beginPath(),n.moveTo(e,t),n.lineTo(e-2*i,t-6*i),n.lineTo(e+2*i,t-6*i),n.save(),n.fillStyle=o.default.line,n.fill(),n.restore(),n.stroke(),n.closePath()}clear(){const{x:e,y:t}=this.translateInfo;this.ctx.clearRect(-e,-t,this.canvas.width,this.canvas.height)}preFill(){const{x:e,y:t}=this.translateInfo;this.ctx.save(),this.ctx.fillStyle="#F3F4F8",this.ctx.fillRect(-e,-t,this.canvas.width,this.canvas.height),this.ctx.restore()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Command=void 0;t.Command=class{constructor({app:e}){this.app=e,this.task={}}register(e,t){if(this.task[e])throw Error(`command ${e} exist`);this.task[e]=t}execute(e,t){const n=this.task[e];n&&n.call(this.app,t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContextMenu=void 0;const o=n(0);t.ContextMenu=class{constructor({app:e,command:t,container:n}){this.app=e,this.command=t,this.container=n,this._init(),this._bind()}_init(){const e=this._createBody();this.body=e,this.container.appendChild(e)}_bind(){this.body.addEventListener("click",e=>{const t=e.target;if(t.classList.contains("editor-contextmenu-item")){let e=o.getAttr(t,"data-command");this.command.execute(e),this.detach()}})}attach(e,{type:t}){switch(this.detach(),this.body.classList.add("show"),this.body.style.left=e.clientX+"px",this.body.style.top=e.clientY+"px",t){case"node":this.body.appendChild(this._createDelItem());break;case"edge":this.body.appendChild(this._createDelEdge());break;default:this.body.appendChild(this._createClearItem())}}detach(){this.body.innerHTML="",this.body.classList.remove("show")}_createBody(){return o.createDom("div","editor-contextmenu bxs","editor-contextmenu")}_createDelItem(){const e=o.createDom("div","editor-contextmenu-item");return e.setAttribute("data-command","del:node"),e.innerText="删除节点",e}_createDelEdge(){const e=o.createDom("div","editor-contextmenu-item");return e.setAttribute("data-command","del:edge"),e.innerText="删除边",e}_createClearItem(){const e=o.createDom("div","editor-contextmenu-item");return e.setAttribute("data-command","clear"),e.innerText="清空",e}}},function(e,t,n){"use strict";n.r(t),n.d(t,"Mind",(function(){return p}));var o=n(0),i=n(9),s=n(1),r=n.n(s),a=n(10),c=n.n(a),d=n(2),l=n.n(d);function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){v(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){function e(t){var n=t.container,i=void 0===n?"#mind-map-container":n,s=t.data,a=void 0===s?{}:s,c=t.options,d=void 0===c?{}:c;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),v(this,"options",{style:{fill:r.a.blue,line:r.a.line,font:r.a.font},lineType:"polygon",legends:null}),v(this,"nodeInfo",{height:26,minWidth:80,horizontalGap:100,verticalHeight:36,fontSize:12}),v(this,"translate",{x:0,y:0}),v(this,"mouseEvent",{isDown:!1,sx:0,sy:0}),v(this,"scale",10),!Object(o.getDom)(i))throw Error("null canvas container found");this.oCon=Object(o.getDom)(i),this.options=u(u({},this.options),d),this._init(),this._setData(a),this._render(),this._bindEvent()}var t,n,s;return t=e,(n=[{key:"_init",value:function(){var e=this.oCon.getBoundingClientRect(),t=e.width,n=e.height,i=e.left,s=e.top,r=window.devicePixelRatio||1;this.config={width:t,height:n,ratio:r,left:i,top:s},console.info("当前屏幕像素密度为".concat(r)),this._initNodeInfo(),this.options.toolbar&&this._initLegends(),this.options.toolbar&&this._initToolbar(this.options.toolbar);var a=Object(o.createDom)("canvas");a.width=t*r,a.height=n*r,this.oCanvas=a,this.ctx=a.getContext("2d"),this.ctx.font="".concat(this.nodeInfo.fontSize,"px Helvetica Neue,Helvetica,PingFang SC,Microsoft YaHei,sans-serif"),this.ctx.textBaseline="middle",this.ctx.textAlign="center",this.ctx.fillStyle=this.options.style.fill,this.ctx.strokeStyle=this.options.style.line,this._initTranslate(),this.oCon.appendChild(this.oCanvas)}},{key:"_initNodeInfo",value:function(){var e=this.config.ratio,t=this.nodeInfo;for(var n in t)t[n]=t[n]*e;t.fontSize=Math.max(10*e,12)}},{key:"_initTranslate",value:function(){this._translate(50*this.config.ratio,this.oCanvas.height/2)}},{key:"_translate",value:function(e,t){this.ctx.translate(e,t),this.translate.x+=e,this.translate.y+=t}},{key:"_reset",value:function(){this._clear(),this.scale=10,this._translate(-this.translate.x,-this.translate.y),this._initTranslate(),this._render()}},{key:"_repaint",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._clear(),this.ctx.save();var n=this.scale/10;this.ctx.transform(n,0,0,n,e,t),this._render(),this.ctx.restore()}},{key:"_setData",value:function(e){this.data=e,Object(i.figureNodeLevel)(this.data)}},{key:"_render",value:function(){var e=this,t=this.data,n=[];n.push(t);for(var o=this.nodeInfo,i=o.horizontalGap,s=o.verticalHeight,r=this.options.lineType,a=function(){var o=n.shift();0===o.level&&e._paintNode(t,{ox:0,oy:0});var a=o.children;if(!a||!a.length)return"continue";"polygon"===r&&e._paintLine({x:o.end,y:o.y},{x:o.end+i/2,y:o.y});var c=a.length;a.forEach((function(t,d){var l=t.count*s/2;l+=d>0?a[d-1].count*s/2+a[d-1].y:o.y-o.count*s/2,e._paintNode(t,{ox:o.end+i,oy:l}),"polygon"===r?(0!==d&&d!==c-1||e._paintLine({x:o.end+i/2,y:o.y},{x:o.end+i/2,y:t.y}),e._paintLine({x:o.end+i/2,y:t.y},{x:t.x,y:t.y})):e._paintCurve({x:o.end,y:o.y},t),n.push(t)}))};n.length;)a()}},{key:"_paintNode",value:function(e,t){var n=t.ox,o=t.oy,i=this.ctx,s=this.options,r=this.nodeInfo,a=r.height,c=r.minWidth,d=i.measureText(e.text),l=Math.max(d.width+20*this.config.ratio,c);if(s.legends&&s.legends[e.type]){var h=s.legends[e.type].color;i.save(),i.fillStyle=h,i.fillRect(n,o-a/2,l,a),i.restore()}else i.fillRect(n,o-a/2,l,a);i.save(),i.fillStyle=s.style.font,i.fillText(e.text,n+l/2,o),i.restore(),e.x=n,e.y=o,e.end=n+l}},{key:"_paintLine",value:function(e,t){var n=this.ctx,o=e.x,i=e.y,s=t.x,r=t.y;n.beginPath(),n.moveTo(o,i),n.lineTo(s,r),n.stroke(),n.closePath()}},{key:"_paintCurve",value:function(e,t){var n=this.ctx,o=e.x,i=e.y,s=t.x,r=t.y;n.beginPath(),n.moveTo(o,i);var a=[(o+s)/2,i],c=[o,r];n.bezierCurveTo(a[0],a[1],c[0],c[1],s,r),n.stroke(),n.closePath()}},{key:"_clear",value:function(){var e=this.translate,t=e.x,n=e.y;this.ctx.clearRect(-t,-n,this.oCanvas.width,this.oCanvas.height)}},{key:"_bindEvent",value:function(){var e=this,t=new l.a({rect:this.config}),n=this.oCanvas;t.add(n,"mousedown",this._mouseDown.bind(this)),t.add(n,"mouseup",this._mouseUp.bind(this)),t.add(n,"mousemove",(function(t){requestAnimationFrame(e._mouseMove.bind(e,t))})),this.event=t}},{key:"_mouseDown",value:function(e){var t=e.offsetX,n=e.offsetY,o=this.config.ratio,i=this.scale/10;this.mouseEvent.isDown=!0,this.mouseEvent.sx=t*o*i,this.mouseEvent.sy=n*o*i}},{key:"_mouseMove",value:function(e){var t=this.mouseEvent,n=t.isDown,o=t.sx,i=t.sy,s=this.scale/10;if(n){var r=e.offsetX,a=e.offsetY,c=this.config.ratio,d=r*c*s-o,l=a*c*s-i;this._repaint(d,l)}}},{key:"_mouseUp",value:function(e){var t=e.offsetX,n=e.offsetY,o=this.mouseEvent,i=o.sx,s=o.sy,r=this.config.ratio,a=this.scale/10;this.mouseEvent.isDown=!1;var c=t*r*a-i,d=n*r*a-s;this._translate(c,d)}},{key:"_zoomIn",value:function(){this.scale<15&&this.scale++,this._repaint(),console.info("当前缩放比例为".concat(this.scale/10))}},{key:"_zoomOut",value:function(){this.scale>5&&this.scale--,this._repaint(),console.info("当前缩放比例为".concat(this.scale/10))}},{key:"_initToolbar",value:function(e){this.toolbar=new c.a({selector:e}),this.toolbar.registerCommands({"zoom-in":this._zoomIn.bind(this),"zoom-out":this._zoomOut.bind(this),reset:this._reset.bind(this),"switch-line":this._switchLine.bind(this)})}},{key:"_initLegends",value:function(){var e=this.options.legends,t=Object(o.createDom)("div","legends-container"),n="";for(var i in e){var s=e[i];n+='<span class="legend-item" style="background-color: '.concat(s.color,'">').concat(s.name,"</span>")}t.innerHTML=n,this.oCon.appendChild(t)}},{key:"_switchLine",value:function(e){var t="curve"===this.options.lineType?"polygon":"curve";this.options.lineType=t,this._repaint()}}])&&f(t.prototype,n),s&&f(t,s),e}()},function(e,t,n){"use strict";n.r(t);var o=n(0),i=n(1),s=n.n(i),r=[{shape:"shape-001",w:160,h:36,color:s.a.blue,name:"Node-ABC",anchors:{input:1,output:1}},{shape:"shape-002",w:160,h:36,color:s.a.red,name:"Node-XYZ",anchors:{input:1,output:2}}],a=n(5);function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var d=function(){function e(t){var n=t.editor;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.editor=n,this.oName=Object(o.getDom)("#node-name"),this.oW=Object(o.getDom)("#node-width"),this._bind()}var t,n,i;return t=e,(n=[{key:"_bind",value:function(){var e=this;this.oName.addEventListener("change",(function(){e.currentNode.name=e.oName.value.trim(),e.editor.repaint()})),this.oW.addEventListener("change",(function(){e.currentNode.w=Number(e.oW.value.trim()),e.editor.repaint()}))}},{key:"currentNode",get:function(){return this.__node},set:function(e){this.__node=e,this.oName.value=e.name,this.oW.value=e.w.toString()}}])&&c(t.prototype,n),i&&c(t,i),e}();function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}var h=new a.Editor({container:"#container",page:"#editor",itempanel:"#itempanel"}),u=new d({editor:h});h.on("nodeAdded",(function(e){console.log("node added",e)})),h.on("selectedNodeChange",(function(e){console.log("selected node changed",e);var t=Object(o.getDom)("#node-panel"),n=Object(o.getDom)("#canvas-panel");e?(t.classList.add("show"),n.classList.remove("show"),u.currentNode=e):(t.classList.remove("show"),n.classList.add("show"))})),h.on("nodeDeleted",(function(e){console.log("node deleted: node-id: ".concat(e))})),h.on("edgeAdded",(function(e){console.log("edge added",e)})),h.on("edgeDeleted",(function(e){console.log("edge deleted",e)}));var f,v=function(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,i=function(){};return{s:i,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return r=e.done,e},e:function(e){a=!0,s=e},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}(r);try{for(v.s();!(f=v.n()).done;){var p=f.value;h.registerShape(p.shape,p)}}catch(e){v.e(e)}finally{v.f()}Object(o.getDom)("#source-btn").addEventListener("click",(function(){h.resize();var e=h.getData();console.log(e),Object(o.getDom)("#code").innerHTML=JSON.stringify(e)})),Object(o.getDom)("#export-btn").addEventListener("click",(function(){console.log("===save==="),h.saveFile().then((function(e){Object(o.getDom)("#preview").src=e}))}))}]);
//# sourceMappingURL=editor.build.js.map